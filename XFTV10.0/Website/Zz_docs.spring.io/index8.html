<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<meta name="author" content="Mark Paluch">
<title>Spring Vault - Reference Documentation</title>
<link rel="stylesheet" href="static/css/spring3.css">
<link rel="stylesheet" href="static/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Vault - Reference Documentation</h1>
<div class="details">
<span id="author" class="author">Mark Paluch</span><br>
<span id="revnumber">version 2.2.2.RELEASE,</span>
<span id="revdate">2020-02-26</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#preface">Preface</a>
<ul class="sectlevel1">
<li><a href="#">1. Document Structure</a></li>
<li><a href="#get-started:first-steps:spring">2. Knowing Spring</a></li>
<li><a href="#get-started:first-steps:vault">3. Knowing Vault</a></li>
<li><a href="#requirements">4. Requirements</a></li>
<li><a href="#">5. Additional Help Resources</a>
<ul class="sectlevel2">
<li><a href="#get-started:help">5.1. Support</a>
<ul class="sectlevel3">
<li><a href="#get-started:help:community">5.1.1. Community Forum</a></li>
<li><a href="#get-started:help:professional">5.1.2. Professional Support</a></li>
</ul>
</li>
<li><a href="#get-started:up-to-date">5.2. Following Development</a></li>
</ul>
</li>
<li><a href="#new-features">6. New &amp; Noteworthy</a>
<ul class="sectlevel2">
<li><a href="#new-features.2-2-0">6.1. What&#8217;s new in Spring Vault 2.2</a></li>
<li><a href="#new-features.2-1-0">6.2. What&#8217;s new in Spring Vault 2.1</a></li>
<li><a href="#new-features.2-0-0">6.3. What&#8217;s new in Spring Vault 2.0</a></li>
<li><a href="#new-features.1-1-0">6.4. What&#8217;s new in Spring Vault 1.1.0</a></li>
<li><a href="#new-features.1-0-0">6.5. What&#8217;s new in Spring Vault 1.0</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#reference-documentation">Reference documentation</a>
<ul class="sectlevel1">
<li><a href="#vault.core">7. Vault support</a>
<ul class="sectlevel2">
<li><a href="#dependencies">7.1. Dependencies</a></li>
<li><a href="#dependencies.spring-framework">7.2. Spring Framework</a></li>
</ul>
</li>
<li><a href="#vault.core.getting-started">8. Getting Started</a></li>
<li><a href="#vault.core.template">9. Introduction to VaultTemplate</a>
<ul class="sectlevel2">
<li><a href="#vault.core.template.beans">9.1. Registering and configuring Spring Vault beans</a></li>
<li><a href="#vault.core.template.sessionmanagement">9.2. Session Management</a></li>
<li><a href="#vault.core.environment-vault-configuration">9.3. Using <code>EnvironmentVaultConfiguration</code></a></li>
<li><a href="#vault.core.executioncallback">9.4. Execution callbacks</a></li>
</ul>
</li>
<li><a href="#vault.core.reactive.template">10. Introduction to ReactiveVaultTemplate</a>
<ul class="sectlevel2">
<li><a href="#">10.1. What is Reactive Programming?</a></li>
<li><a href="#">10.2. Reactive Vault Client</a></li>
<li><a href="#vault.core.reactive.template.beans">10.3. Registering and configuring Spring Vault beans</a></li>
<li><a href="#vault.core.reactive.template.sessionmanagement">10.4. Session Management</a></li>
<li><a href="#vault.core.reactive.executioncallback">10.5. Execution callbacks</a></li>
</ul>
</li>
<li><a href="#vault.core.propertysupport">11. Vault Property Source Support</a>
<ul class="sectlevel2">
<li><a href="#">11.1. Registering <code>VaultPropertySource</code></a></li>
<li><a href="#">11.2. @VaultPropertySource</a></li>
</ul>
</li>
<li><a href="#vault.repositories">12. Vault Repositories</a>
<ul class="sectlevel2">
<li><a href="#vault.repositories.usage">12.1. Usage</a></li>
<li><a href="#vault.repositories.mapping">12.2. Object to Vault JSON Mapping</a></li>
<li><a href="#vault.repositories.queries">12.3. Queries and Query Methods</a>
<ul class="sectlevel3">
<li><a href="#">12.3.1. Sorting and Paging</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#vault.core.client.support">13. Client support</a>
<ul class="sectlevel2">
<li><a href="#">13.1. Java&#8217;s builtin <code>HttpURLConnection</code></a></li>
<li><a href="#">13.2. External Clients</a></li>
<li><a href="#vault.client-ssl">13.3. Vault Client SSL configuration</a></li>
</ul>
</li>
<li><a href="#vault.core.authentication">14. Authentication Methods</a>
<ul class="sectlevel2">
<li><a href="#">14.1. Externalizing login credentials</a></li>
<li><a href="#vault.authentication.token">14.2. Token authentication</a></li>
<li><a href="#vault.authentication.appid">14.3. AppId authentication</a>
<ul class="sectlevel3">
<li><a href="#">14.3.1. Custom UserId</a></li>
</ul>
</li>
<li><a href="#vault.authentication.approle">14.4. AppRole authentication</a></li>
<li><a href="#vault.authentication.awsec2">14.5. AWS-EC2 authentication</a></li>
<li><a href="#vault.authentication.awsiam">14.6. AWS-IAM authentication</a></li>
<li><a href="#vault.authentication.azuremsi">14.7. Azure (MSI) authentication</a></li>
<li><a href="#vault.authentication.gcpgce">14.8. GCP-GCE authentication</a></li>
<li><a href="#vault.authentication.gcpiam">14.9. GCP-IAM authentication</a></li>
<li><a href="#vault.authentication.pcf">14.10. PCF authentication</a></li>
<li><a href="#vault.authentication.clientcert">14.11. TLS certificate authentication</a></li>
<li><a href="#vault.authentication.cubbyhole">14.12. Cubbyhole authentication</a></li>
<li><a href="#vault.authentication.kubernetes">14.13. Kubernetes authentication</a></li>
<li><a href="#vault.authentication.steps">14.14. Authentication Steps</a></li>
<li><a href="#vault.authentication.session">14.15. Token Lifecycle</a></li>
</ul>
</li>
<li><a href="#vault.misc">15. Miscellaneous</a>
<ul class="sectlevel2">
<li><a href="#vault.misc.spring-security">15.1. Spring Security</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2016-2020 The original authors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<em>Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.</em>
</td>
</tr>
</table>
</div>

</div>
</div>
<h1 id="preface" class="sect0"><a class="anchor" href="#preface"></a>Preface</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>The Spring Vault project applies core Spring concepts to the development of solutions using HashiCorp Vault. We provide a "template" as a high-level abstraction for storing and querying documents. You will notice similarities to the REST support in the Spring Framework.</p>
</div>
<div class="paragraph">
<p>This document is the reference guide for Spring Vault. It explains Vault concepts and semantics and the syntax.</p>
</div>
<div class="paragraph">
<p>This part of the reference documentation explains the core functionality offered by Spring Vault.</p>
</div>
<div class="paragraph">
<p><a href="#vault.core">Vault support</a> introduces the Vault module feature set.</p>
</div>
</div>
</div>
<div class="sect1">
<h2>1. Document Structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section provides basic introduction to Spring and Vault.
It contains details about following development and how to get support.</p>
</div>
<div class="paragraph">
<p>The rest of the document refers to Spring Vault features and assumes
the user is familiar with <a href="javascript:window.open('https://www.vaultproject.io/');">HashiCorp Vault</a>
as well as Spring concepts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:spring"><a class="anchor" href="#get-started:first-steps:spring"></a>2. Knowing Spring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault uses Spring framework&#8217;s <a href="javascript:window.open('https://docs.spring.io/spring/docs/5.2.4.RELEASE/spring-framework-reference/core.html');">core</a> functionality, such as <a href="javascript:window.open('https://docs.spring.io/spring/docs/5.2.4.RELEASE/spring-framework-reference//core.html');">IoC</a> container. While it is not important to know the Spring APIs, understanding the concepts behind them is. At a minimum, the idea behind IoC should be familiar for whatever IoC container you choose to use.</p>
</div>
<div class="paragraph">
<p>The core functionality of the Vault support can be used directly, with no need to invoke the IoC services of the Spring Container. This is much like <code>RestTemplate</code> which can be used 'standalone' without any other services of the Spring container. To leverage all the features of Spring Vault document, such as the session support, you will need to configure some parts of the library using Spring.</p>
</div>
<div class="paragraph">
<p>To learn more about Spring, you can refer to the comprehensive (and sometimes disarming) documentation that explains in detail the Spring Framework. There are a lot of articles, blog entries and books on the matter - take a look at the Spring framework <a href="javascript:window.open('https://spring.io/docs');">home page </a> for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:vault"><a class="anchor" href="#get-started:first-steps:vault"></a>3. Knowing Vault</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Security and working with secrets is a concern of every developer working with databases, user credentials or API keys. Vault steps in by providing a secure storage combined with access control, revocation, key rolling and auditing. In short: Vault is a service for securely accessing and storing secrets. A secret is anything that you want to tightly control access to, such as API keys, passwords, certificates, and more.</p>
</div>
<div class="paragraph">
<p>The jumping off ground for learning about Vault is <a href="javascript:window.open('https://www.vaultproject.io/');">www.vaultproject.io</a>. Here is a list of useful resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The manual introduces Vault and contains links to getting started guides, reference documentation and tutorials.</p>
</li>
<li>
<p>The online shell provides a convenient way to interact with a Vault instance in combination with the online tutorial.</p>
</li>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/intro/index.html');">HashiCorp Vault Introduction</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/index.html');">HashiCorp Vault Documentation</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Vault provides client-side support for accessing, storing and revoking secrets.
With <a href="javascript:window.open('https://www.vaultproject.io/');">HashiCorp&#8217;s Vault</a> you have a central place to
manage external secret data for applications across all environments.
Vault can manage static and dynamic secrets such as application data,
username/password for remote applications/resources and provide credentials
for external services such as MySQL, PostgreSQL, Apache Cassandra, Consul, AWS and more.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements"><a class="anchor" href="#requirements"></a>4. Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault 2.x binaries requires JDK level 8.0 and above, and <a href="javascript:window.open('https://spring.io/docs');">Spring Framework</a> 5.2.4.RELEASE and above.</p>
</div>
<div class="paragraph">
<p>In terms of Vault, <a href="javascript:window.open('https://www.vaultproject.io/');">Vault</a> at least 0.6.</p>
</div>
</div>
</div>
<div class="sect1">
<h2>5. Additional Help Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learning a new framework is not always straight forward. In this section, we try to provide what we think is an easy to follow guide for starting with Spring Vault module. However, if you encounter issues or you are just looking for advice, feel free to use one of the links below:</p>
</div>
<div class="sect2">
<h3 id="get-started:help"><a class="anchor" href="#get-started:help"></a>5.1. Support</h3>
<div class="paragraph">
<p>There are a few support options available:</p>
</div>
<div class="sect3">
<h4 id="get-started:help:community"><a class="anchor" href="#get-started:help:community"></a>5.1.1. Community Forum</h4>
<div class="paragraph">
<p>Post questions questions regarding Spring Vault on <a href="javascript:window.open('https://stackoverflow.com/questions/tagged/spring-vault');">Stackoverflow</a> to share information and help each other. Note that registration is needed <strong>only</strong> for posting.</p>
</div>
</div>
<div class="sect3">
<h4 id="get-started:help:professional"><a class="anchor" href="#get-started:help:professional"></a>5.1.2. Professional Support</h4>
<div class="paragraph">
<p>Professional, from-the-source support, with guaranteed response time, is available from <a href="javascript:window.open('https://pivotal.io/');">Pivotal Sofware, Inc.</a>, the company behind Spring Vault and Spring.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="get-started:up-to-date"><a class="anchor" href="#get-started:up-to-date"></a>5.2. Following Development</h3>
<div class="paragraph">
<p>For information on the Spring Vault source code repository, nightly builds and snapshot artifacts please see the <a href="javascript:window.open('https://projects.spring.io/spring-vault/');">Spring Vault homepage</a>. You can help make Spring Vault best serve the needs of the Spring community by interacting with developers through the Community on <a href="javascript:window.open('https://stackoverflow.com/questions/tagged/spring-vault');">Stackoverflow</a>. If you encounter a bug or want to suggest an improvement, please create a ticket on the Spring Vault issue <a href="javascript:window.open('https://github.com/spring-projects/spring-vault/issues');">tracker</a>. To stay up to date with the latest news and announcements in the Spring ecosystem, subscribe to the Spring Community <a href="javascript:window.open('https://spring.io/');">Portal</a>. Lastly, you can follow the Spring <a href="javascript:window.open('https://spring.io/blog');">blog </a>or the project team on Twitter (<a href="javascript:window.open('https://twitter.com/springcentral');">SpringCentral</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="new-features"><a class="anchor" href="#new-features"></a>6. New &amp; Noteworthy</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new-features.2-2-0"><a class="anchor" href="#new-features.2-2-0"></a>6.1. What&#8217;s new in Spring Vault 2.2</h3>
<div class="ulist">
<ul>
<li>
<p>Support for Key-Value v2 (versioned backend) secrets through <code>@VaultPropertySource</code>.</p>
</li>
<li>
<p>SpEL support in <code>@Secret</code>.</p>
</li>
<li>
<p>Add support for Jetty as reactive HttpClient.</p>
</li>
<li>
<p><code>LifecycleAwareSessionManager</code> and <code>ReactiveLifecycleAwareSessionManager</code> emit now <code>AuthenticationEvent</code>s.</p>
</li>
<li>
<p><a href="#vault.authentication.pcf">PCF authentication</a>.</p>
</li>
<li>
<p>Deprecation of <code>AppIdAuthentication</code>. Use <code>AppRoleAuthentication</code> instead as recommended by HashiCorp Vault.</p>
</li>
<li>
<p><code>CubbyholeAuthentication</code> and wrapped <code>AppRoleAuthentication</code> now use <code>sys/wrapping/unwrap</code> endpoints by default.</p>
</li>
<li>
<p>Kotlin Coroutines support for <code>ReactiveVaultOperations</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.2-1-0"><a class="anchor" href="#new-features.2-1-0"></a>6.2. What&#8217;s new in Spring Vault 2.1</h3>
<div class="ulist">
<ul>
<li>
<p><a href="#vault.authentication.gcpgce">GCP Compute</a>, <a href="#vault.authentication.gcpiam">GCP IAM</a>, and <a href="#vault.authentication.azuremsi">Azure</a> authentication.</p>
</li>
<li>
<p>Template API support for versioned and unversioned Key/Value backends and for Vault wrapping operations.</p>
</li>
<li>
<p>Support full pull mode in reactive AppRole authentication.</p>
</li>
<li>
<p>Improved Exception hierarchy for Vault login failures.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.2-0-0"><a class="anchor" href="#new-features.2-0-0"></a>6.3. What&#8217;s new in Spring Vault 2.0</h3>
<div class="ulist">
<ul>
<li>
<p>Authentication steps DSL to <a href="#vault.authentication.steps">compose authentication flows</a>.</p>
</li>
<li>
<p><a href="#vault.core.reactive.template">Reactive Vault client</a> via <code>ReactiveVaultOperations</code>.</p>
</li>
<li>
<p><a href="#vault.repositories">Vault repository support</a> based on Spring Data KeyValue.</p>
</li>
<li>
<p>Transit batch encrypt and decrypt support.</p>
</li>
<li>
<p>Policy management for policies stored as JSON.</p>
</li>
<li>
<p>Support CSR signing, certificate revocation and CRL retrieval.</p>
</li>
<li>
<p><a href="#vault.authentication.kubernetes">Kubernetes authentication</a>.</p>
</li>
<li>
<p>RoleId/SecretId unwrapping for <a href="#vault.authentication.approle">AppRole authentication</a>.</p>
</li>
<li>
<p><a href="#vault.misc.spring-security">Spring Security integration</a> with transit backend-based <code>BytesKeyGenerator</code> and <code>BytesEncryptor</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-1-0"><a class="anchor" href="#new-features.1-1-0"></a>6.4. What&#8217;s new in Spring Vault 1.1.0</h3>
<div class="ulist">
<ul>
<li>
<p><a href="#vault.authentication.awsiam">AWS IAM authentication</a>.</p>
</li>
<li>
<p>Configuration of encryption/decryption versions for transit keys.</p>
</li>
<li>
<p>Pull mode for <a href="#vault.authentication.approle">AppRole authentication</a>.</p>
</li>
<li>
<p>Transit batch encrypt and decrypt support.</p>
</li>
<li>
<p>TTL-based generic secret rotation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-0-0"><a class="anchor" href="#new-features.1-0-0"></a>6.5. What&#8217;s new in Spring Vault 1.0</h3>
<div class="ulist">
<ul>
<li>
<p>Initial Vault support.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<h1 id="reference-documentation" class="sect0"><a class="anchor" href="#reference-documentation"></a>Reference documentation</h1>
<div class="sect1">
<h2 id="vault.core"><a class="anchor" href="#vault.core"></a>7. Vault support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Vault support contains a wide range of features which are summarized below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring configuration support using Java based @Configuration classes</p>
</li>
<li>
<p><code>VaultTemplate</code> helper class that increases productivity performing common
Vault operations. Includes integrated object mapping between Vault responses and POJOs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most tasks, you will find yourself using <code>VaultTemplate</code> that leverages the
rich communication functionality. <code>VaultTemplate</code> is the place to look for
accessing functionality such as reading data from Vault or issuing
administrative commands. <code>VaultTemplate</code> also provides callback methods so that it is easy for you to
get a hold of the low-level API artifacts such as <code>RestTemplate</code> to communicate
directly with Vault.</p>
</div>
<div class="sect2">
<h3 id="dependencies"><a class="anchor" href="#dependencies"></a>7.1. Dependencies</h3>
<div class="paragraph">
<p>The easiest way to find compatible versions of Spring Vault dependencies
is by relying on the Spring Vault BOM we ship with the compatible versions
defined. In a Maven project you would declare this dependency in the
<code>&lt;dependencyManagement /&gt;</code> section of your <code>pom.xml</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Using the Spring Vault BOM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.vault&lt;/groupId&gt;
      &lt;artifactId&gt;spring-vault-dependencies&lt;/artifactId&gt;
      &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
      &lt;scope&gt;import&lt;/scope&gt;
      &lt;type&gt;pom&lt;/type&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
</div>
<div id="dependencies.names" class="paragraph">
<p>The current version is <code>2.2.2.RELEASE</code>. The version name follows the following
pattern: <code>${version}-${release}</code> where release can be one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BUILD-SNAPSHOT</code> - current snapshots</p>
</li>
<li>
<p><code>M1</code>, <code>M2</code> etc. - milestones</p>
</li>
<li>
<p><code>RC1</code>, <code>RC2</code> etc. - release candidates</p>
</li>
<li>
<p><code>RELEASE</code> - GA release</p>
</li>
<li>
<p><code>SR1</code>, <code>SR2</code> etc. - service releases</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 2. Declaring a dependency to Spring Vault</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.vault&lt;/groupId&gt;
        &lt;artifactId&gt;spring-vault-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencies.spring-framework"><a class="anchor" href="#dependencies.spring-framework"></a>7.2. Spring Framework</h3>
<div class="paragraph">
<p>The current version of Spring Vault requires Spring Framework in version
5.2.4.RELEASE or better. The modules might also work with an older bugfix
version of that minor version. However, using the most recent version
within that generation is highly recommended.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.getting-started"><a class="anchor" href="#vault.core.getting-started"></a>8. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault support requires Vault 0.6 or higher and Java SE 6 or higher.
An easy way to bootstrap setting up a working environment is to create a
Spring based project in <a href="javascript:window.open('https://spring.io/tools/sts');">STS</a>.</p>
</div>
<div class="paragraph">
<p>First you need to set up a running Vault server.
Refer to the <a href="javascript:window.open('https://www.vaultproject.io/intro/');">Vault</a> for an explanation on how to startup a Vault instance.</p>
</div>
<div class="paragraph">
<p>To create a Spring project in STS go to File &#8594; New &#8594;
Spring Template Project &#8594; Simple Spring Utility Project &#8594;
press Yes when prompted. Then enter a project and a package name such as <code>org.spring.vault.example</code>.</p>
</div>
<div class="paragraph">
<p>Then add the following to <code>pom.xml</code> dependencies section.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Adding Spring Vault dependency</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;

  &lt;!-- other dependency elements omitted --&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.vault&lt;/groupId&gt;
    &lt;artifactId&gt;spring-vault-core&lt;/artifactId&gt;
    &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
  &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you are using a milestone or release candidate, you will also need to add the location of the Spring
Milestone repository to your maven <code>pom.xml</code> which is at the same level of your <code>&lt;dependencies/&gt;</code> element.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;repositories&gt;
  &lt;repository&gt;
    &lt;id&gt;spring-milestone&lt;/id&gt;
    &lt;name&gt;Spring Maven MILESTONE Repository&lt;/name&gt;
    &lt;url&gt;https://repo.spring.io/libs-milestone&lt;/url&gt;
  &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The repository is also <a href="javascript:window.open('https://repo.spring.io/milestone/org/springframework/vault/');">browseable here</a>.</p>
</div>
<div class="paragraph">
<p>If you are using a SNAPSHOT, you will also need to add the location of the Spring
Snapshot repository to your maven <code>pom.xml</code> which is at the same level of your <code>&lt;dependencies/&gt;</code> element.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;repositories&gt;
  &lt;repository&gt;
    &lt;id&gt;spring-snapshot&lt;/id&gt;
    &lt;name&gt;Spring Maven SNAPSHOT Repository&lt;/name&gt;
    &lt;url&gt;https://repo.spring.io/libs-snapshot&lt;/url&gt;
  &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The repository is also <a href="javascript:window.open('https://repo.spring.io/snapshot/org/springframework/vault/');">browseable here</a>.</p>
</div>
<div class="paragraph">
<p>Create a simple <code>Secrets</code> class to persist:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Mapped data object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.spring.vault.example;

public class Secrets {

    String username;
    String password;

    public String getUsername() {
        return username;
    }

    public String getPassword() {
        return password;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And a main application to run</p>
</div>
<div class="exampleblock">
<div class="title">Example 5. Example application using Spring Vault</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.springframework.vault.example;

import org.springframework.vault.authentication.TokenAuthentication;
import org.springframework.vault.client.VaultEndpoint;
import org.springframework.vault.core.VaultTemplate;
import org.springframework.vault.support.VaultResponseSupport;

public class VaultApp {

    public static void main(String[] args) {

        VaultTemplate vaultTemplate = new VaultTemplate(new VaultEndpoint(),
                new TokenAuthentication("00000000-0000-0000-0000-000000000000"));

        Secrets secrets = new Secrets();
        secrets.username = "hello";
        secrets.password = "world";

        vaultTemplate.write("secret/myapp", secrets);

        VaultResponseSupport&lt;Secrets&gt; response = vaultTemplate.read("secret/myapp", Secrets.class);
        System.out.println(response.getData().getUsername());

        vaultTemplate.delete("secret/myapp");
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even in this simple example, there are few things to take notice of</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can instantiate the central class of Spring Vault,
<a href="#vault.core.template"><code>VaultTemplate</code></a>, using the <code>org.springframework.vault.client.VaultEndpoint</code>
object and the <code>ClientAuthentication</code>.
You are not required to spin up a Spring Context to use Spring Vault.</p>
</li>
<li>
<p>Vault is expected to be configured with a root token of
<code>00000000-0000-0000-0000-000000000000</code> to run this application.</p>
</li>
<li>
<p>The mapper works against standard POJO objects without the need for any
additional metadata (though you can optionally provide that information).</p>
</li>
<li>
<p>Mapping conventions can use field access. Notice the <code>Secrets</code> class has only getters.</p>
</li>
<li>
<p>If the constructor argument names match the field names of the stored document,
they will be used to instantiate the object.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.template"><a class="anchor" href="#vault.core.template"></a>9. Introduction to VaultTemplate</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The class <code>VaultTemplate</code>, located in the package <code>org.springframework.vault.core</code>,
is the central class of the Spring&#8217;s Vault support providing a rich feature set to
interact with Vault. The template offers convenience operations to read, write and
delete data in Vault and provides a mapping between your domain objects and Vault data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once configured, <code>VaultTemplate</code> is thread-safe and can be reused across
multiple instances.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The mapping between Vault documents and domain classes is done by delegating to
<code>RestTemplate</code>. Spring Web support provides the mapping infrastructure.</p>
</div>
<div class="paragraph">
<p>The <code>VaultTemplate</code> class implements the interface <code>VaultOperations</code>.
In as much as possible, the methods on <code>VaultOperations</code> are named after methods
available on the Vault API to make the API familiar to existing Vault developers
who are used to the API and CLI. For example, you will find methods such as
"write", "delete", "read", and "revoke".
The design goal was to make it as easy as possible to transition between
the use of the Vault API and <code>VaultOperations</code>. A major difference in between
the two APIs is that <code>VaultOperations</code> can be passed domain objects instead of
JSON Key-Value pairs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>VaultTemplate</code> instance
is via its interface <code>VaultOperations</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While there are many convenience methods on <code>VaultTemplate</code> to help you easily
perform common tasks if you should need to access the Vault API directly to access
functionality not explicitly exposed by the <code>VaultTemplate</code> you can use one of
several execute callback methods to access underlying APIs. The execute callbacks
will give you a reference to a <code>RestOperations</code> object.
Please see the section <a href="#vault.core.executioncallback">Execution Callbacks</a> for more information.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at a examples of how to work with Vault in the context of the Spring container.</p>
</div>
<div class="sect2">
<h3 id="vault.core.template.beans"><a class="anchor" href="#vault.core.template.beans"></a>9.1. Registering and configuring Spring Vault beans</h3>
<div class="paragraph">
<p>Using Spring Vault does not require a Spring Context. However, instances of <code>VaultTemplate</code> and <code>SessionManager</code> registered inside a managed context will participate
in <a href="javascript:window.open('https://docs.spring.io/spring/docs/5.2.4.RELEASE/spring-framework-reference/core.html#beans-factory-nature');">lifecycle events</a>
provided by the Spring IoC container. This is useful to dispose active Vault sessions upon
application shutdown. You also benefit from reusing the same <code>VaultTemplate</code>
instance across your application.</p>
</div>
<div class="paragraph">
<p>Spring Vault comes with a supporting configuration class that provides bean definitions
for use inside a Spring context. Application configuration
classes typically extend from <code>AbstractVaultConfiguration</code> and are required to
provide additional details that are environment specific.</p>
</div>
<div class="paragraph">
<p>Extending from <code>AbstractVaultConfiguration</code> requires to implement
` VaultEndpoint vaultEndpoint()` and <code>ClientAuthentication clientAuthentication()</code>
methods.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Registering Spring Vault objects using Java based bean metadata</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class AppConfig extends AbstractVaultConfiguration {

    /**
     * Specify an endpoint for connecting to Vault.
     */
    @Override
    public VaultEndpoint vaultEndpoint() {
        return new VaultEndpoint();                            <i class="conum" data-value="1"></i><b>(1)</b>
    }

    /**
     * Configure a client authentication.
     * Please consider a more secure authentication method
     * for production use.
     */
    @Override
    public ClientAuthentication clientAuthentication() {
        return new TokenAuthentication("…");                   <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new <code>VaultEndpoint</code> that points by default to <code>https://localhost:8200</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This sample uses <code>TokenAuthentication</code> to get started quickly.
See <a href="#vault.core.authentication">Authentication Methods</a> for details on supported authentication methods.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 7. Registering Spring Vault applying injected properties</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class AppConfig extends AbstractVaultConfiguration {

    @Value("${vault.uri}")
    URI vaultUri;

    /**
     * Specify an endpoint that was injected as URI.
     */
    @Override
    public VaultEndpoint vaultEndpoint() {
        return VaultEndpoint.from(vaultUri);                          <i class="conum" data-value="1"></i><b>(1)</b>
    }

    /**
     * Configure a Client Certificate authentication.
     * {@link RestOperations} can be obtained from {@link #restOperations()}.
     */
    @Override
    public ClientAuthentication clientAuthentication() {
        return new ClientCertificateAuthentication(restOperations()); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>VaultEndpoint</code> can be constructed using various factory methods such as
<code>from(URI uri)</code> or <code>VaultEndpoint.create(String host, int port)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dependencies for <code>ClientAuthentication</code> methods can be obtained either from
<code>AbstractVaultConfiguration</code> or provided by your configuration.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Creating a custom configuration class might be cumbersome in some cases.
Take a look at <code>EnvironmentVaultConfiguration</code> that allows configuration by using
properties from existing property sources and Spring&#8217;s <code>Environment</code>. Read more
in <a href="#vault.core.environment-vault-configuration">Using <code>EnvironmentVaultConfiguration</code></a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.template.sessionmanagement"><a class="anchor" href="#vault.core.template.sessionmanagement"></a>9.2. Session Management</h3>
<div class="paragraph">
<p>Spring Vault requires a <code>ClientAuthentication</code> to login and access Vault.
See <a href="#vault.core.authentication">Authentication Methods</a> on details regarding authentication.
Vault login should not occur on each authenticated Vault interaction but
must be reused throughout a session. This aspect is handled by a
<code>SessionManager</code> implementation. A <code>SessionManager</code> decides how often it
obtains a token, about revocation and renewal. Spring Vault comes with two implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SimpleSessionManager</code>: Just obtains tokens from the supplied
<code>ClientAuthentication</code> without refresh and revocation</p>
</li>
<li>
<p><code>LifecycleAwareSessionManager</code>: This <code>SessionManager</code> schedules token
renewal if a token is renewable and revoke a login token on disposal.
Renewal is scheduled with an <code>AsyncTaskExecutor</code>. <code>LifecycleAwareSessionManager</code>
is configured by default if using <code>AbstractVaultConfiguration</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.environment-vault-configuration"><a class="anchor" href="#vault.core.environment-vault-configuration"></a>9.3. Using <code>EnvironmentVaultConfiguration</code></h3>
<div class="paragraph">
<p>Spring Vault includes <code>EnvironmentVaultConfiguration</code> configure the Vault client from Spring&#8217;s <code>Environment</code> and a set of predefined
property keys. <code>EnvironmentVaultConfiguration</code> supports frequently applied configurations. Other configurations are supported by deriving from the most appropriate configuration class. Include <code>EnvironmentVaultConfiguration</code> with <code>@Import(EnvironmentVaultConfiguration.class)</code> to existing
Java-based configuration classes and supply configuration properties through any of Spring&#8217;s <code>PropertySource</code>s.</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Using EnvironmentVaultConfiguration with a property file</div>
<div class="content">
<div class="listingblock">
<div class="title">Java-based configuration class</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@PropertySource("vault.properties")
@Import(EnvironmentVaultConfiguration.class)
public class MyConfiguration{
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">vault.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">vault.uri=https://localhost:8200
vault.token=00000000-0000-0000-0000-000000000000</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Property keys</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vault URI: <code>vault.uri</code></p>
</li>
<li>
<p>SSL Configuration</p>
<div class="ulist">
<ul>
<li>
<p>Keystore resource: <code>vault.ssl.key-store</code> (optional)</p>
</li>
<li>
<p>Keystore password: <code>vault.ssl.key-store-password</code> (optional)</p>
</li>
<li>
<p>Truststore resource: <code>vault.ssl.trust-store</code> (optional)</p>
</li>
<li>
<p>Truststore password: <code>vault.ssl.trust-store-password</code> (optional)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Authentication method: <code>vault.authentication</code> (defaults to <code>TOKEN</code>, supported authentication methods are: <code>TOKEN</code>, <code>APPID</code>, <code>APPROLE</code>, <code>AWS_EC2</code>, <code>AZURE</code>, <code>CERT</code>, <code>CUBBYHOLE</code>, <code>KUBERNETES</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Authentication-specific property keys</strong></p>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.token">Token authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vault Token: <code>vault.token</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.appid">AppId authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>AppId path: <code>vault.app-id.app-id-path</code> (defaults to <code>app-id</code>)</p>
</li>
<li>
<p>AppId: <code>vault.app-id.app-id</code></p>
</li>
<li>
<p>UserId: <code>vault.app-id.user-id</code>. <code>MAC_ADDRESS</code> and <code>IP_ADDRESS</code> use <code>MacAddressUserId</code>, respective <code>IpAddressUserId</code> user id mechanisms.
Any other value is used with <code>StaticUserId</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.approle">AppRole authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>AppRole path: <code>vault.app-role.app-role-path</code> (defaults to <code>approle</code>)</p>
</li>
<li>
<p>RoleId: <code>vault.app-role.role-id</code></p>
</li>
<li>
<p>SecretId: <code>vault.app-role.secret-id</code> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.awsec2">AWS-EC2 authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>AWS EC2 path: <code>vault.aws-ec2.aws-ec2-path</code> (defaults to <code>aws-ec2</code>)</p>
</li>
<li>
<p>Role: <code>vault.aws-ec2.role</code></p>
</li>
<li>
<p>RoleId: <code>vault.aws-ec2.role-id</code> (<strong>deprecated:</strong> use <code>vault.aws-ec2.role</code> instead)</p>
</li>
<li>
<p>Identity Document URL: <code>vault.aws-ec2.identity-document</code> (defaults to <code><a href="javascript:window.open('http://169.254.169.254/latest/dynamic/instance-identity/pkcs7');" class="bare">http://169.254.169.254/latest/dynamic/instance-identity/pkcs7</a></code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.azuremsi">Azure (MSI) authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure MSI path: <code>vault.azure-msi.azure-path</code> (defaults to <code>azure</code>)</p>
</li>
<li>
<p>Role: <code>vault.azure-msi.role</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.clientcert">TLS certificate authentication</a></strong></p>
</div>
<div class="paragraph">
<p>No configuration options.</p>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.cubbyhole">Cubbyhole authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initial Vault Token: <code>vault.token</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><a href="#vault.authentication.kubernetes">Kubernetes authentication</a></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kubernetes path: <code>vault.kubernetes.kubernetes-path</code> (defaults to <code>kubernetes</code>)</p>
</li>
<li>
<p>Role: <code>vault.kubernetes.role</code></p>
</li>
<li>
<p>Path to service account token file: <code>vault.kubernetes.service-account-token-file</code> (defaults to <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.executioncallback"><a class="anchor" href="#vault.core.executioncallback"></a>9.4. Execution callbacks</h3>
<div class="paragraph">
<p>One common design feature of all Spring template classes is that all functionality is routed into one of the templates execute callback methods.
This helps ensure that exceptions and any resource management that maybe required are performed consistency.
While this was of much greater need in the case of JDBC and JMS than with Vault, it still offers a single spot for access and logging to occur.
As such, using the execute callback is the preferred way to access the Vault API
to perform uncommon operations that we&#8217;ve not exposed as methods on <code>VaultTemplate</code>.</p>
</div>
<div class="paragraph">
<p>Here is a list of execute callback methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;T&gt; T</code> <strong>doWithVault</strong> <code>(RestOperationsCallback&lt;T&gt; callback)</code> Executes the given
<code>RestOperationsCallback</code>, allows to interact with Vault using <code>RestOperations</code> without requiring a session.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>doWithSession</strong> <code>(RestOperationsCallback&lt;T&gt; callback)</code> Executes the given
<code>RestOperationsCallback</code>, allows to interact with Vault in an authenticated session.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example that uses the <code>ClientCallback</code> to initialize Vault:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">vaultOperations.doWithVault(new RestOperationsCallback&lt;VaultInitializationResponse&gt;() {

  @Override
  public VaultInitializationResponse doWithRestOperations(RestOperations restOperations) {

    ResponseEntity&lt;VaultInitializationResponse&gt; exchange = restOperations
                       .exchange("/sys/init", HttpMethod.PUT,
                                 new HttpEntity&lt;Object&gt;(request),
                                 VaultInitializationResponse.class);

    return exchange.getBody();
    }
});</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.reactive.template"><a class="anchor" href="#vault.core.reactive.template"></a>10. Introduction to ReactiveVaultTemplate</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers basic information on the reactive programming support using Spring Vault.</p>
</div>
<div class="sect2">
<h3>10.1. What is Reactive Programming?</h3>
<div class="paragraph">
<p>In plain terms reactive programming is about non-blocking applications that are
asynchronous and event-driven and require a small number of threads to scale vertically
(i.e. within the JVM) rather than horizontally (i.e. through clustering).</p>
</div>
<div class="paragraph">
<p>A key aspect of reactive applications is the concept of backpressure which is a mechanism
to ensure producers don’t overwhelm consumers. For example in a pipeline of reactive
components extending from the database to the HTTP response when the HTTP connection is
too slow the data repository can also slow down or stop completely until network capacity frees up.</p>
</div>
</div>
<div class="sect2">
<h3>10.2. Reactive Vault Client</h3>
<div class="paragraph">
<p>Spring Vault&#8217;s reactive client support is built on top of <a href="#vault.authentication.steps">composable authentication steps</a> and Spring&#8217;s functional <code>WebClient</code> via Reactor Netty or Jetty, which feature both a fully non-blocking, event-driven HTTP client.</p>
</div>
<div class="paragraph">
<p>It exposes <code>VaultTokenSupplier</code> as supplier of <code>VaultToken</code> to authenticate HTTP requests
and <code>ReactiveVaultOperations</code> as the primary entry point. The core configuration of
<code>VaultEndpoint</code>, <code>ClientOptions</code> and <a href="#vault.client-ssl">SSL</a> are reused across the
various client implementation.</p>
</div>
<div class="paragraph">
<p>The class <code>ReactiveVaultTemplate</code>, located in the package <code>org.springframework.vault.core</code>,
is the central class of the Spring&#8217;s reactive Vault support providing a rich feature set to
interact with Vault. The template offers convenience operations to read, write and
delete data in Vault and provides a mapping between your domain objects and Vault data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once configured, <code>ReactiveVaultTemplate</code> is thread-safe and can be reused across
multiple instances.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The mapping between Vault documents and domain classes is done by delegating to
<code>WebClient</code> and its codecs.</p>
</div>
<div class="paragraph">
<p>The <code>ReactiveVaultTemplate</code> class implements the interface <code>ReactiveVaultOperations</code>.
In as much as possible, the methods on <code>ReactiveVaultOperations</code> are named after methods
available on the Vault API to make the API familiar to existing Vault developers
who are used to the API and CLI. For example, you will find methods such as
"write", "delete", and "read".
The design goal was to make it as easy as possible to transition between
the use of the Vault API and <code>ReactiveVaultOperations</code>. A major difference in between
the two APIs is that <code>ReactiveVaultOperations</code> can be passed domain objects instead of
JSON Key-Value pairs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>ReactiveVaultTemplate</code> instance
is via its interface <code>ReactiveVaultOperations</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Functionality not explicitly exposed by the <code>ReactiveVaultTemplate</code> you can use one of
several execute callback methods to access underlying APIs. The execute callbacks
will give you a reference to a <code>WebClient</code> object.
Please see the section <a href="#vault.core.reactive.executioncallback">Execution Callbacks</a> for more information.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at a examples of how to work with Vault in the context of the Spring container.</p>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.reactive.template.beans"><a class="anchor" href="#vault.core.reactive.template.beans"></a>10.3. Registering and configuring Spring Vault beans</h3>
<div class="paragraph">
<p>Using Spring Vault does not require a Spring Context. However, instances of
<code>ReactiveVaultTemplate</code> and <code>VaultTokenSupplier</code> registered inside a managed context will participate
in <a href="javascript:window.open('https://docs.spring.io/spring/docs/5.2.4.RELEASE/spring-framework-reference/core.html#beans-factory-nature');">lifecycle events</a>
provided by the Spring IoC container. This is useful to dispose active Vault sessions upon
application shutdown. You also benefit from reusing the same <code>ReactiveVaultTemplate</code>
instance across your application.</p>
</div>
<div class="paragraph">
<p>Spring Vault comes with a supporting configuration class that provides bean definitions
for use inside a Spring context. Application configuration
classes typically extend from <code>AbstractVaultConfiguration</code> and are required to
provide additional details that are environment specific.</p>
</div>
<div class="paragraph">
<p>Extending from <code>AbstractVaultConfiguration</code> requires to implement
` VaultEndpoint vaultEndpoint()` and <code>ClientAuthentication clientAuthentication()</code>
methods.</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Registering Spring Vault objects using Java based bean metadata</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class AppConfig extends AbstractReactiveVaultConfiguration {

    /**
     * Specify an endpoint for connecting to Vault.
     */
    @Override
    public VaultEndpoint vaultEndpoint() {
        return new VaultEndpoint();                            <i class="conum" data-value="1"></i><b>(1)</b>
    }

    /**
     * Configure a client authentication.
     * Please consider a more secure authentication method
     * for production use.
     */
    @Override
    public ClientAuthentication clientAuthentication() {
        return new TokenAuthentication("…");                   <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new <code>VaultEndpoint</code> that points by default to <code>https://localhost:8200</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This sample uses <code>TokenAuthentication</code> to get started quickly.
See <a href="#vault.core.authentication">Authentication Methods</a> for details on supported authentication methods.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.reactive.template.sessionmanagement"><a class="anchor" href="#vault.core.reactive.template.sessionmanagement"></a>10.4. Session Management</h3>
<div class="paragraph">
<p>Spring Vault requires a token to authenticate Vault requests.
See <a href="#vault.core.authentication">Authentication Methods</a> on details regarding authentication.
The reactive client requires a non-blocking token supplier whose contract is defined
in <code>VaultTokenSupplier</code>. Tokens can be static or obtained through a
<a href="#vault.authentication.steps">declared authentication flow</a>.
Vault login should not occur on each authenticated Vault interaction but
the session token should be kept across a session. This aspect is handled by a
session manager implementing <code>ReactiveSessionManager</code>, such as <code>ReactiveLifecycleAwareSessionManager</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="vault.core.reactive.executioncallback"><a class="anchor" href="#vault.core.reactive.executioncallback"></a>10.5. Execution callbacks</h3>
<div class="paragraph">
<p>One common design feature of all Spring template classes is that all functionality
is routed into one of the templates execute callback methods. This helps ensure
that exceptions and any resource management that maybe required are performed
consistency. While this was of much greater need in the case of JDBC and JMS
than with Vault, it still offers a single spot for access and logging to occur.
As such, using the execute callback is the preferred way to access the Vault API
to perform uncommon operations that we&#8217;ve not exposed as methods on <code>ReactiveVaultTemplate</code>.</p>
</div>
<div class="paragraph">
<p>Here is a list of execute callback methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;T&gt; T</code> <strong>doWithVault</strong> <code>(Function&lt;WebClient, ? extends T&gt; clientCallback)</code> Composes a reactive
sequence the given <code>WebClient</code>, allows to interact with Vault without a session context.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>doWithSession</strong> <code>(Function&lt;WebClient, ? extends T&gt; clientCallback)</code> Composes a reactive
sequence the given <code>WebClient</code>, allows to interact with Vault in an authenticated session.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example that uses the callback to initialize Vault:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">reactiveVaultOperations.doWithVault(webClient -&gt; {

    return webClient.put()
                    .uri("/sys/init")
                    .syncBody(request)
                    .retrieve()
                    .toEntity(VaultInitializationResponse.class);
});</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.propertysupport"><a class="anchor" href="#vault.core.propertysupport"></a>11. Vault Property Source Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vault can be used in many different ways. One specific use-case is using
Vault to store encrypted properties. Spring Vault supports Vault as property
source to obtain configuration properties using Spring&#8217;s <a href="javascript:window.open('https://docs.spring.io/spring/docs/5.2.4.RELEASE/spring-framework-reference/core.html#beans-property-source-abstraction');">PropertySource abstraction</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can reference properties stored inside Vault in other property sources or use value injection with <code>@Value(…)</code>. Special attention is required when bootstrapping beans that require data stored inside of Vault. A <code>VaultPropertySource</code> must be initialized at that time to retrieve properties from Vault.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring Boot/Spring Cloud users can benefit from <a href="javascript:window.open('https://github.com/spring-cloud/spring-cloud-vault-config');">Spring Cloud Vault</a>'s
configuration integration that initializes various property sources during application startup.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3>11.1. Registering <code>VaultPropertySource</code></h3>
<div class="paragraph">
<p>Spring Vault provides a <code>VaultPropertySource</code> to be used with Vault to obtain
properties. It uses the nested <code>data</code> element to expose properties stored and
encrypted in Vault.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ConfigurableApplicationContext ctx = new GenericApplicationContext();
MutablePropertySources sources = ctx.getEnvironment().getPropertySources();
sources.addFirst(new VaultPropertySource(vaultTemplate, "secret/my-application"));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the code above, <code>VaultPropertySource</code> has been added with highest precedence
in the search. If it contains a ´foo` property, it will be detected and returned
ahead of any <code>foo</code> property in any other <code>PropertySource</code>.
<code>MutablePropertySources</code> exposes a number of methods that allow for precise
manipulation of the set of property sources.</p>
</div>
</div>
<div class="sect2">
<h3>11.2. @VaultPropertySource</h3>
<div class="paragraph">
<p>The <code>@VaultPropertySource</code> annotation provides a convenient and declarative
mechanism for adding a <code>PropertySource</code> to Spring&#8217;s <code>Environment</code>
to be used in conjunction with <code>@Configuration</code> classes.</p>
</div>
<div class="paragraph">
<p><code>@VaultPropertySource</code> takes a Vault path such as <code>secret/my-application</code>
and exposes the data stored at the node in a <code>PropertySource</code>.
<code>@VaultPropertySource</code> supports lease renewal for secrets associated with a lease
(i. e. credentials from the <code>mysql</code> backend) and credential rotation upon terminal
lease expiration. Lease renewal is disabled by default.</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Properties stored in Vault</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  // …

  "data": {
    "database": {
      "password": ...
    },
    "user.name": ...,
  }

  // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 11. Declaring a <code>@VaultPropertySource</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@VaultPropertySource("secret/my-application")
public class AppConfig {

    @Autowired Environment env;

    @Bean
    public TestBean testBean() {
        TestBean testBean = new TestBean();
        testBean.setUser(env.getProperty("user.name"));
        testBean.setPassword(env.getProperty("database.password"));
        return testBean;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 12. Declaring a <code>@VaultPropertySource</code> with credential rotation and prefix</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@VaultPropertySource(value = "aws/creds/s3-access",
                     propertyNamePrefix = "aws.",
                     renewal = Renewal.ROTATE)
public class AppConfig {
  // provides aws.access_key and aws.secret_key properties
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Secrets obtained from <code>generic</code> secret backends are associated with a TTL (<code>refresh_interval</code>) but not a lease Id. Spring Vault&#8217;s <code>PropertySource</code> rotates generic secrets when reaching its TTL.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can use <code>@VaultPropertySource</code> to obtain the newest secret version from the versioned Key-Value backend. Make sure to not include the <code>data/</code> segment in the path.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any <code>${…​}</code> placeholders present in a <code>@VaultPropertySource</code> path are resolved against the set of property sources already registered against the environment, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Declaring a <code>@VaultPropertySource</code> path using placeholders</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@VaultPropertySource(value = "aws/creds/${my.placeholder:fallback/value}",
                     propertyNamePrefix = "aws.",
                     renewal = Renewal.ROTATE)
public class AppConfig {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Assuming that <code>my.placeholder</code> is present in one of the property sources already registered (for example, system properties or environment variables), the placeholder is resolved to the corresponding value.
If not, then <code>fallback/value</code> is used as a default.
If no default is specified and a property cannot be resolved, an <code>IllegalArgumentException</code> is thrown.</p>
</div>
<div class="paragraph">
<p>In certain situations, it may not be possible or practical to tightly control
property source ordering when using <code>@VaultPropertySource</code> annotations.
For example, if the <code>@Configuration</code> classes above were registered via
component-scanning, the ordering is difficult to predict.
In such cases - and if overriding is important - it is recommended that the
user fall back to using the programmatic PropertySource API.
See <a href="javascript:window.open('https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/env/ConfigurableEnvironment.html');"><code>ConfigurableEnvironment</code></a> and
<a href="javascript:window.open('https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/env/MutablePropertySources.html');"><code>MutablePropertySources</code></a> for details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.repositories"><a class="anchor" href="#vault.repositories"></a>12. Vault Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Working with <code>VaultTemplate</code> and responses mapped to Java classes allows basic data operations like read, write
and delete. Vault repositories apply Spring Data&#8217;s repository concept on top of Vault.
A Vault repository exposes basic CRUD functionality and supports query derivation with predicates constraining
the Id property, paging and sorting.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Read more about Spring Data Repositories in the <a href="javascript:window.open('https://docs.spring.io/spring-data/commons/docs/current/reference/html/#repositories');">Spring Data Commons reference documentation</a>. The reference documentation will give you an introduction to Spring Data repositories.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="vault.repositories.usage"><a class="anchor" href="#vault.repositories.usage"></a>12.1. Usage</h3>
<div class="paragraph">
<p>To access domain entities stored in Vault you can leverage repository support that eases implementing those quite significantly.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Sample Credentials Entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Secret
public class Credentials {

  @Id String id;
  String password;
  String socialSecurityNumber;
  Address address;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We have a pretty simple domain object here. Note that it has a property named <code>id</code> annotated with
<code>org.springframework.data.annotation.Id</code> and a <code>@Secret</code> annotation on its type.
Those two are responsible for creating the actual key used to persist the object as JSON inside Vault.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Properties annotated with <code>@Id</code> as well as those named <code>id</code> are considered as the identifier properties.
Those with the annotation are favored over others.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next step is to declare a repository interface that uses the domain object.</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Basic Repository Interface for <code>Credentials</code> entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface CredentialsRepository extends CrudRepository&lt;Credentials, String&gt; {

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As our repository extends <code>CrudRepository</code> it provides basic CRUD and query methods. Vault repositories
require Spring Data components. Make sure to include <code>spring-data-commons</code> and <code>spring-data-keyvalue</code> artifacts in your class path.</p>
</div>
<div class="paragraph">
<p>The easiest way to achive this, is by setting up dependency management and adding the artifacts to your <code>pom.xml</code>:</p>
</div>
<div class="paragraph">
<p>Then add the following to <code>pom.xml</code> dependencies section.</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Using the Spring Data BOM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
      &lt;artifactId&gt;spring-data-releasetrain&lt;/artifactId&gt;
      &lt;version&gt;Moore-SR5&lt;/version&gt;
      &lt;scope&gt;import&lt;/scope&gt;
      &lt;type&gt;pom&lt;/type&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependencies&gt;

  &lt;!-- other dependency elements omitted --&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.vault&lt;/groupId&gt;
    &lt;artifactId&gt;spring-vault-core&lt;/artifactId&gt;
    &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-keyvalue&lt;/artifactId&gt;
    &lt;!-- Version inherited from the BOM --&gt;
  &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The thing we need in between to glue things together is the according Spring configuration.</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. JavaConfig for Vault Repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableVaultRepositories
public class ApplicationConfig {

  @Bean
  public VaultTemplate vaultTemplate() {
    return new VaultTemplate(…);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Given the setup above we can go on and inject <code>CredentialsRepository</code> into our components.</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Access to Person Entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Autowired CredentialsRepository repo;

public void basicCrudOperations() {

  Credentials creds = new Credentials("heisenberg", "327215", "AAA-GG-SSSS");
  rand.setAddress(new Address("308 Negra Arroyo Lane", "Albuquerque", "New Mexico", "87104"));

  repo.save(creds);                                        <i class="conum" data-value="1"></i><b>(1)</b>

  repo.findOne(creds.getId());                             <i class="conum" data-value="2"></i><b>(2)</b>

  repo.count();                                            <i class="conum" data-value="3"></i><b>(3)</b>

  repo.delete(creds);                                      <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Stores properties of <code>Credentials</code> inside Vault Hash with a key pattern <code>keyspace/id</code>,
in this case <code>credentials/heisenberg</code>, in the generic secret backend.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Uses the provided id to retrieve the object stored at <code>keyspace/id</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Counts the total number of entities available within the keyspace <em>credentials</em> defined by <code>@Secret</code> on <code>Credentials</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Removes the key for the given object from Vault.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.repositories.mapping"><a class="anchor" href="#vault.repositories.mapping"></a>12.2. Object to Vault JSON Mapping</h3>
<div class="paragraph">
<p>Vault repositories store objects in Vault using JSON as interchange format. Object mapping between JSON and
the entity is done by <code>VaultConverter</code>. The converter reads and writes <code>SecretDocument</code> that contains the body
from a <code>VaultResponse</code>. <code>VaultResponse</code>s are read from Vault and the body is deserialized by
Jackson into a <code>Map</code> of <code>String</code> and <code>Object</code>.
The default <code>VaultConverter</code> implementation reads the <code>Map</code> with nested values, <code>List</code> and <code>Map</code> objects and
converts these to entities and vice versa.</p>
</div>
<div class="paragraph">
<p>Given the <code>Credentials</code> type from the previous sections the default mapping is as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "_class": "org.example.Credentials",                 <i class="conum" data-value="1"></i><b>(1)</b>
  "password", "327215",                                <i class="conum" data-value="2"></i><b>(2)</b>
  "socialSecurityNumber": "AAA-GG-SSSS",
  "address": {                                         <i class="conum" data-value="3"></i><b>(3)</b>
    "street": "308 Negra Arroyo Lane",
    "city": "Albuquerque",
    "state": "New Mexico",
    "zip":"87104"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>_class</code> attribute is included on root level as well as on any nested interface or abstract types.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Simple property values are mapped by path.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Properties of complex types are mapped as nested objects.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>@Id</code> property must be mapped to <code>String</code>.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Default Mapping Rules</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Sample</th>
<th class="tableblock halign-left valign-top">Mapped Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple Type<br>
(eg. String)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String firstname = "Walter";</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">firstname = "Walter"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complex Type<br>
(eg. Address)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address adress = new Address("308 Negra Arroyo Lane");</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">address: { "street": "308 Negra Arroyo Lane" }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List<br>
of Simple Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List&lt;String&gt; nicknames = asList("walt", "heisenberg");</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nicknames: ["walt", "heisenberg"]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map<br>
of Simple Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map&lt;String, Integer&gt; atts = asMap("age", 51)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">atts : {"age" : 51}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List<br>
of Complex Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List&lt;Address&gt; addresses = asList(new Address("308…</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">address: [{ "street": "308 Negra Arroyo Lane" }, …]</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can customize the mapping behavior by registering a <code>Converter</code> in <code>VaultCustomConversions</code>.
Those converters can take care of converting from/to a type such as <code>LocalDate</code> as well as <code>SecretDocument</code>
whereas the first one is suitable for converting simple properties and the last one complex types to their JSON
representation. The second option offers full control over the resulting <code>SecretDocument</code>. Writing objects to <code>Vault</code>
will delete the content and re-create the whole entry, so not mapped data will be lost.</p>
</div>
</div>
<div class="sect2">
<h3 id="vault.repositories.queries"><a class="anchor" href="#vault.repositories.queries"></a>12.3. Queries and Query Methods</h3>
<div class="paragraph">
<p>Query methods allow automatic derivation of simple queries from the method name. Vault has no query engine but
requires direct access of HTTP context paths. Vault query methods translate Vault&#8217;s API possibilities to queries.
A query method execution lists children under a context path, applies filtering to the Id, optionally limits the
Id stream with offset/limit and applies sorting after fetching the results.</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Sample Repository Query Method</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface CredentialsRepository extends CrudRepository&lt;Credentials, String&gt; {

  List&lt;Credentials&gt; findByIdStartsWith(String prefix);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Query methods for Vault repositories support only queries with predicates on the <code>@Id</code> property.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s an overview of the keywords supported for Vault.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Supported keywords for query methods</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Keyword</th>
<th class="tableblock halign-left valign-top">Sample</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code>, <code>GreaterThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdGreaterThan(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdGreaterThanEqual(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code>, <code>LessThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdLessThan(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdLessThanEqual(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdBetween(String from, String to)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>In</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdIn(Collection ids)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotIn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdNotIn(Collection ids)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code>, <code>StartingWith</code>, <code>EndingWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdLike(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotLike</code>, <code>IsNotLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdNotLike(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameContaining(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotContaining</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNotContaining(String name)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdRegex(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(No keyword)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findById(String name)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByIdNot(String id)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>And</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLastnameAndFirstname</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Or</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLastnameOrFirstname</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Is,Equals</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstname</code>,<code>findByFirstnameIs</code>,<code>findByFirstnameEquals</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Top,First</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findFirst10ByFirstname</code>,<code>findTop5ByFirstname</code></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4>12.3.1. Sorting and Paging</h4>
<div class="paragraph">
<p>Query methods support sorting and paging by selecting in memory a sublist (offset/limit) Id&#8217;s retrieved from
a Vault context path. Sorting has is not limited to a particular field, unlike query method predicates.
Unpaged sorting is applied after Id filtering and all resulting secrets are fetched from Vault. This way
a query method fetches only results that are also returned as part of the result.</p>
</div>
<div class="paragraph">
<p>Using paging and sorting requires secret fetching before filtering the Id&#8217;s which impacts performance.
Sorting and paging guarantees to return the same result even if the natural order of Id returned by Vault changes.
Therefore, all Id&#8217;s are fetched from Vault first, then sorting is applied and afterwards filtering and offset/limiting.</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Paging and Sorting Repository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface CredentialsRepository extends PagingAndSortingRepository&lt;Credentials, String&gt; {

  List&lt;Credentials&gt; findTop10ByIdStartsWithOrderBySocialSecurityNumberDesc(String prefix);

  List&lt;Credentials&gt; findByIdStarts(String prefix, Pageable pageRequest);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.client.support"><a class="anchor" href="#vault.core.client.support"></a>13. Client support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Vault supports various HTTP clients to access Vault&#8217;s HTTP API. Spring Vault uses
<a href="javascript:window.open('https://docs.spring.io/spring/docs/5.2.4.RELEASE/spring-framework-reference/integration.html#rest-resttemplate');"><code>RestTemplate</code></a> as primary interface accessing Vault.
Dedicated client support originates from <a href="#vault.client-ssl">customized SSL configuration</a>
that is scoped only to Spring Vault&#8217;s client components.</p>
</div>
<div class="paragraph">
<p>Spring Vault supports following HTTP imperative clients:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java&#8217;s builtin <code>HttpURLConnection</code> (default client)</p>
</li>
<li>
<p>Apache Http Components</p>
</li>
<li>
<p>Netty</p>
</li>
<li>
<p>OkHttp 3</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Vault&#8217;s reactive integration supports the following reactive HTTP clients:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reactor Netty</p>
</li>
<li>
<p>Jetty</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using a specific client requires the according dependency to be available on the classpath
so Spring Vault can use the available client for communicating with Vault.</p>
</div>
<div class="sect2">
<h3>13.1. Java&#8217;s builtin <code>HttpURLConnection</code></h3>
<div class="paragraph">
<p>Java&#8217;s builtin <code>HttpURLConnection</code> is available out-of-the-box without additional
configuration. Using <code>HttpURLConnection</code> comes with a limitation regarding SSL configuration.
Spring Vault won&#8217;t apply <a href="#vault.client-ssl">customized SSL configuration</a> as it would
require a deep reconfiguration of the JVM. This configuration would affect all
components relying on the default SSL context. Configuring SSL settings using
<code>HttpURLConnection</code> requires you providing these settings as System Properties. See
<a href="javascript:window.open('https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html#InstallationAndCustomization');">Customizing JSSE</a> for further details.</p>
</div>
</div>
<div class="sect2">
<h3>13.2. External Clients</h3>
<div class="paragraph">
<p>You can use external clients to access Vault&#8217;s API. Simply add one of the following
dependencies to your project. You can omit the version number if using
<a href="#dependencies">Spring Vault&#8217;s Dependency BOM</a></p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Apache Http Components Dependency</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
  &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Apache HttpClient&#8217;s <a href="javascript:window.open('https://hc.apache.org/httpcomponents-client-4.5.x/logging.html');">wire logging</a> can be enabled through logging configuration. Make sure to not accidentally enable wire logging as logs may expose traffic (tokens and secrets) between your application and Vault in plain text.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 22. Netty Dependency</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.netty&lt;/groupId&gt;
  &lt;artifactId&gt;netty-all&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 23. Square OkHttp 3</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;
  &lt;artifactId&gt;okhttp&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 24. Reactor Netty</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.projectreactor.netty&lt;/groupId&gt;
  &lt;artifactId&gt;reactor-netty&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 25. Jetty</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
  &lt;artifactId&gt;jetty-reactive-httpclient&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.client-ssl"><a class="anchor" href="#vault.client-ssl"></a>13.3. Vault Client SSL configuration</h3>
<div class="paragraph">
<p>SSL can be configured using <code>SslConfiguration</code> by setting various properties.
You can set either <code>javax.net.ssl.trustStore</code> to configure
JVM-wide SSL settings or configure <code>SslConfiguration</code>
to set SSL settings only for Spring Vault.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SslConfiguration sslConfiguration = SslConfiguration.create(            <i class="conum" data-value="1"></i><b>(1)</b>
		new FileSystemResource("client-cert.jks"), "changeit".toCharArray(),
		new FileSystemResource("truststore.jks"), "changeit".toCharArray());

SslConfiguration.forTrustStore(new FileSystemResource("keystore.jks"),  <i class="conum" data-value="2"></i><b>(2)</b>
                                      "changeit".toCharArray())

SslConfiguration.forKeyStore(new FileSystemResource("keystore.jks"),    <i class="conum" data-value="3"></i><b>(3)</b>
                                      "changeit".toCharArray())

SslConfiguration.forKeyStore(new FileSystemResource("keystore.jks"),    <i class="conum" data-value="4"></i><b>(4)</b>
                                      "changeit".toCharArray(),
                                      KeyConfiguration.of("key-password".toCharArray(),
                                      "my-key-alias"))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Full configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuring only trust store settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configuring only key store settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configuring only key store settings with providing a key-configuration.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Please note that providing <code>SslConfiguration</code> can be only
applied when either Apache Http Components or the OkHttp client
is on your class-path.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.core.authentication"><a class="anchor" href="#vault.core.authentication"></a>14. Authentication Methods</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Different organizations have different requirements for security
and authentication. Vault reflects that need by shipping multiple authentication
methods. Spring Vault supports multiple authentications mechanisms.</p>
</div>
<div class="sect2">
<h3>14.1. Externalizing login credentials</h3>
<div class="paragraph">
<p>Obtaining first-time access to a secured system is known as secure introduction.
Any client requires ephemeral or permanent credentials to access Vault. Externalizing credentials
is a good pattern to keep code maintainability high but comes at a risk of increased disclosure.</p>
</div>
<div class="paragraph">
<p>Disclosure of login credentials to any party allows login to Vault and access secrets that
are permitted by the underlying role. Picking the appropriate client authentication and
injecting credentials into the application is subject to risk evaluation.</p>
</div>
<div class="paragraph">
<p>Spring&#8217;s <a href="javascript:window.open('https://docs.spring.io/spring/docs/5.2.4.RELEASE/spring-framework-reference/core.html#beans-property-source-abstraction');">PropertySource abstraction</a> is a natural fit
to keep configuration outside the application code. You can use system properties, environment
variables or property files to store login credentials. Each approach comes with its own properties.
Keep in mind that the command line and environment properties can be introspected with appropriate
OS access levels.</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Externalizing <code>vault.token</code> to a properties file</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@PropertySource("configuration.properties")
@Configuration
public class Config extends AbstractVaultConfiguration {

    @Override
    public ClientAuthentication clientAuthentication() {
        return new TokenAuthentication(getEnvironment().getProperty("vault.token"));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Spring allows multiple ways to obtain <code>Environment</code>. When using <code>VaultPropertySource</code>, injection via <code>@Autowired Environment environment</code> will not provide the <code>Environment</code> as the environment bean is still in construction and autowiring comes at a later stage. Your configuration class should rather implement <code>ApplicationContextAware</code> and obtain the <code>Environment</code> from <code>ApplicationContext</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="javascript:window.open('https://github.com/spring-projects/spring-vault/blob/master/spring-vault-core/src/test/java/org/springframework/vault/demo/SecurePropertyUsage.java');"><code>SecurePropertyUsage.java</code></a>
for a sample on referencing properties in components and other property sources.</p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.token"><a class="anchor" href="#vault.authentication.token"></a>14.2. Token authentication</h3>
<div class="paragraph">
<p>Tokens are the core method for authentication within Vault.
Token authentication requires a static token to be provided.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Token authentication is the default authentication method.
If a token is disclosed an unintended party, it gains access to Vault and
can access secrets for the intended client.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Typically, Token authentication is used in scenarios in which the token is created and renewed
externally (such as <a href="javascript:window.open('https://github.com/hashicorp/vault-service-broker');">HashiCorp Vault service broker</a>).
Depending on the actual setup, you may or may not want token renewal and revocation.
See <a href="#vault.authentication.session"><code>LifecycleAwareSessionManager</code></a> for details about TTL and token revocation.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        return new TokenAuthentication("…");
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/concepts/tokens.html');">Vault Documentation: Tokens</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/token.html');">Vault Documentation: Using the Token auth backend</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.appid"><a class="anchor" href="#vault.authentication.appid"></a>14.3. AppId authentication</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
AppId authentication is deprecated by Vault. Use <a href="#vault.authentication.approle">AppRole authentication</a> instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vault supports <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/app-id.html');">AppId</a>
authentication that consists of two hard to guess tokens. The AppId
defaults to <code>spring.application.name</code> that is statically configured.
The second token is the UserId which is a part determined by the application,
usually related to the runtime environment. IP address, Mac address or a
Docker container name are good examples. Spring Vault supports
IP address, Mac address and static UserId&#8217;s (e.g. supplied via System properties).
The IP and Mac address are represented as Hex-encoded SHA256 hash.</p>
</div>
<div class="paragraph">
<p>IP address-based UserId&#8217;s use the local host&#8217;s IP address.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        AppIdAuthenticationOptions options = AppIdAuthenticationOptions.builder()
                .appId("myapp")
                .userIdMechanism(new IpAddressUserId())
                .build();

        return new AppIdAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The corresponding command to generate the IP address UserId from a command line is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ echo -n 192.168.99.1 | sha256sum</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Including the line break of <code>echo</code> leads to a different hash value
so make sure to include the <code>-n</code> flag.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mac address-based UserId&#8217;s obtain their network device from the
localhost-bound device. The configuration also allows specifying
a <code>network-interface</code> hint to pick the right device. The value of
<code>network-interface</code> is optional and can be either an interface
name or interface index (0-based).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        AppIdAuthenticationOptions options = AppIdAuthenticationOptions.builder()
                .appId("myapp")
                .userIdMechanism(new MacAddressUserId())
                .build();

        return new AppIdAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The corresponding command to generate the Mac address UserId from a command line is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ echo -n 0AFEDE1234AC | sha256sum</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Mac address is specified uppercase and without colons.
Including the line break of <code>echo</code> leads to a different hash value
so make sure to include the <code>-n</code> flag.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4>14.3.1. Custom UserId</h4>
<div class="paragraph">
<p>A more advanced approach lets you implementing your own <code>AppIdUserIdMechanism</code>.
This class must be on your classpath and must implement
the <code>org.springframework.vault.authentication.AppIdUserIdMechanism</code> interface
and the <code>createUserId</code> method. Spring Vault will obtain the UserId
by calling <code>createUserId</code> each time it authenticates using AppId to
obtain a token.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">MyUserIdMechanism.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyUserIdMechanism implements AppIdUserIdMechanism {

  @Override
  public String createUserId() {

    String userId = …
    return userId;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also: <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/app-id.html');">Vault Documentation: Using the App ID auth backend</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.approle"><a class="anchor" href="#vault.authentication.approle"></a>14.4. AppRole authentication</h3>
<div class="paragraph">
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/app-id.html');">AppRole</a> allows machine
authentication, like the deprecated (since Vault 0.6.1) <a href="#vault.authentication.appid">AppId authentication</a>.
AppRole authentication consists of two hard to guess (secret) tokens: RoleId and SecretId.</p>
</div>
<div class="paragraph">
<p>Spring Vault supports AppRole authentication by providing either RoleId only
or together with a provided SecretId and fetching RoleId/SecretId from Vault
(push and pull modes with response unwrapping).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        AppRoleAuthenticationOptions options = AppRoleAuthenticationOptions.builder()
                .roleId(RoleId.provided("…"))
                .secretId(SecretId.wrapped(VaultToken.of("…")))
                .build();

        return new AppRoleAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Spring Vault also support full pull mode: If RoleId and SecretId are not provided,
Spring Vault will retrieve them using the role name and an initial token. The
initial token may be associated with a TTL and usage limit.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        VaultToken initialToken = VaultToken.of("…");
        AppRoleAuthenticationOptions options = AppRoleAuthenticationOptions.builder()
                .appRole("…")
                .roleId(RoleId.pull(initialToken))
                .secretId(SecretId.pull(initialToken))
                .build();

        return new AppRoleAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also: <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/approle.html');">Vault Documentation: Using the AppRole auth backend</a></p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.awsec2"><a class="anchor" href="#vault.authentication.awsec2"></a>14.5. AWS-EC2 authentication</h3>
<div class="paragraph">
<p>The <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/aws-ec2.html');">aws-ec2</a>
auth backend provides a secure introduction mechanism
for AWS EC2 instances, allowing automated retrieval of a Vault
token. Unlike most Vault authentication backends, this backend
does not require first-deploying, or provisioning security-sensitive
credentials (tokens, username/password, client certificates, etc.).
Instead, it treats AWS as a Trusted Third Party and uses the
cryptographically signed dynamic metadata information that uniquely
represents each EC2 instance.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        return new AwsEc2Authentication(restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>AWS-EC2 authentication enables nonce by default to follow
the Trust On First Use (TOFU) principle. Any unintended party that
gains access to the PKCS#7 identity metadata can authenticate
against Vault.</p>
</div>
<div class="paragraph">
<p>During the first login, Spring Vault generates a nonce
that is stored in the auth backend aside the instance Id.
Re-authentication requires the same nonce to be sent. Any other
party does not have the nonce and can raise an alert in Vault for
further investigation.</p>
</div>
<div class="paragraph">
<p>The nonce is kept in memory and is lost during application restart.</p>
</div>
<div class="paragraph">
<p>AWS-EC2 authentication roles are optional and default to the AMI.
You can configure the authentication role by setting
it in <code>AwsEc2AuthenticationOptions</code>.</p>
</div>
<div class="paragraph">
<p>See also: <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/aws-ec2.html');">Vault Documentation: Using the AWS-EC2 auth backend</a></p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.awsiam"><a class="anchor" href="#vault.authentication.awsiam"></a>14.6. AWS-IAM authentication</h3>
<div class="paragraph">
<p>The <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/aws.html');">aws</a>
auth backend allows Vault login by using existing AWS IAM credentials.</p>
</div>
<div class="paragraph">
<p>AWS IAM authentication creates a signed HTTP request that is
executed by Vault to get the identity of the signer using AWS STS
<code>GetCallerIdentity</code> method. AWSv4 signatures require IAM credentials.</p>
</div>
<div class="paragraph">
<p>IAM credentials can be obtained from either the runtime environment
or supplied externally. Runtime environments such as AWS-EC2,
Lambda and ECS with assigned IAM principals do not require client-specific
configuration of credentials but can obtain these from its metadata source.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        AwsIamAuthenticationOptions options = AwsIamAuthenticationOptions.builder()
                .credentials(new BasicAWSCredentials(…)).build();

        return new AwsIamAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 27. Using AWS-EC2 instance profile as credentials source</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        AwsIamAuthenticationOptions options = AwsIamAuthenticationOptions.builder()
                .credentialsProvider(InstanceProfileCredentialsProvider.getInstance()).build();

        return new AwsIamAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>AwsIamAuthentication</code> requires the AWS Java SDK dependency (<code>com.amazonaws:aws-java-sdk-core</code>)
as the authentication implementation uses AWS SDK types for credentials and request signing.</p>
</div>
<div class="paragraph">
<p>You can configure the authentication via <code>AwsIamAuthenticationOptions</code>.</p>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/aws.html');">Vault Documentation: Using the AWS auth backend</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html');">AWS Documentation: STS GetCallerIdentity</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.azuremsi"><a class="anchor" href="#vault.authentication.azuremsi"></a>14.7. Azure (MSI) authentication</h3>
<div class="paragraph">
<p>The <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/azure.html');">azure</a>
auth backend provides a secure introduction mechanism
for Azure VM instances, allowing automated retrieval of a Vault
token. Unlike most Vault authentication backends, this backend
does not require first-deploying, or provisioning security-sensitive
credentials (tokens, username/password, client certificates, etc.).
Instead, it treats Azure as a Trusted Third Party and uses the
managed service identity and instance metadata information that can be
bound to a VM instance.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        AzureMsiAuthenticationOptions options = AzureMsiAuthenticationOptions.builder()
                    .role(…).build();

        return new AzureMsiAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Azure authentication requires details about the VM environment (subscription Id,
resource group name, VM name). These details can be either configured through
<code>AzureMsiAuthenticationOptionsBuilder</code>.
If left unconfigured, <code>AzureMsiAuthentication</code> queries Azure&#8217;s instance metadata service to
obtain these details.</p>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/azure.html');">Vault Documentation: Using the Azure auth backend</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://docs.microsoft.com/en-us/azure/active-directory/managed-service-identity/overview');">Azure Documentation: Managed Service Identity</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.gcpgce"><a class="anchor" href="#vault.authentication.gcpgce"></a>14.8. GCP-GCE authentication</h3>
<div class="paragraph">
<p>The <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/gcp.html');">gcp</a>
auth backend allows Vault login by using existing GCP (Google Cloud Platform) IAM and GCE credentials.</p>
</div>
<div class="paragraph">
<p>GCP GCE (Google Compute Engine) authentication creates a signature in the form of a
JSON Web Token (JWT) for a service account. A JWT for a Compute Engine instance
is obtained from the GCE metadata service using <a href="javascript:window.open('https://cloud.google.com/compute/docs/instances/verifying-instance-identity');">Instance identification</a>.
This API creates a JSON Web Token that can be used to confirm the instance identity.</p>
</div>
<div class="paragraph">
<p>Unlike most Vault authentication backends, this backend
does not require first-deploying, or provisioning security-sensitive
credentials (tokens, username/password, client certificates, etc.).
Instead, it treats GCP as a Trusted Third Party and uses the
cryptographically signed dynamic metadata information that uniquely
represents each GCP service account.</p>
</div>
<div class="paragraph">
<p>You can configure the authentication via <code>GcpComputeAuthenticationOptions</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        GcpComputeAuthenticationOptions options = GcpComputeAuthenticationOptions.builder()
				.role(…).build();

		GcpComputeAuthentication authentication = new GcpComputeAuthentication(options,
				restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/gcp.html');">Vault Documentation: Using the GCP auth backend</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://cloud.google.com/compute/docs/instances/verifying-instance-identity');">GCP Documentation: Verifying the Identity of Instances</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.gcpiam"><a class="anchor" href="#vault.authentication.gcpiam"></a>14.9. GCP-IAM authentication</h3>
<div class="paragraph">
<p>The <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/gcp.html');">gcp</a>
auth backend allows Vault login by using existing GCP (Google Cloud Platform) IAM and GCE credentials.</p>
</div>
<div class="paragraph">
<p>GCP IAM authentication creates a signature in the form of a JSON Web Token (JWT)
for a service account. A JWT for a service account is obtained by
calling GCP IAM&#8217;s <a href="javascript:window.open('https://cloud.google.com/iam/reference/rest/v1/projects.serviceAccounts/signJwt');"><code>projects.serviceAccounts.signJwt</code></a> API. The caller authenticates against GCP IAM
and proves thereby its identity. This Vault backend treats GCP as a Trusted Third Party.</p>
</div>
<div class="paragraph">
<p>IAM credentials can be obtained from either the runtime environment
or supplied externally as e.g. JSON. JSON is the preferred form as it
carries the project id and service account identifier required for calling
<code>projects.serviceAccounts.signJwt</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        GcpIamAuthenticationOptions options = GcpIamAuthenticationOptions.builder()
				.role(…).credential(GoogleCredentials.getApplicationDefault()).build();

		GcpIamAuthentication authentication = new GcpIamAuthentication(options,
				restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>GcpIamAuthenticationOptions</code> requires the Google Cloud Java SDK dependency
(<code>com.google.apis:google-api-services-iam</code> and <code>com.google.auth:google-auth-library-oauth2-http</code>)
as the authentication implementation uses Google APIs for credentials and JWT signing.</p>
</div>
<div class="paragraph">
<p>You can configure the authentication via <code>GcpIamAuthenticationOptions</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Google credentials require an OAuth 2 token maintaining the token lifecycle. All API
is synchronous therefore, <code>GcpIamAuthentication</code> does not support <code>AuthenticationSteps</code> which is
required for reactive usage.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/gcp.html');">Vault Documentation: Using the GCP auth backend</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://cloud.google.com/iam/reference/rest/v1/projects.serviceAccounts/signJwt');">GCP Documentation: projects.serviceAccounts.signJwt</a><a id="vault.authentication.gcpiam"></a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.pcf"><a class="anchor" href="#vault.authentication.pcf"></a>14.10. PCF authentication</h3>
<div class="paragraph">
<p>The <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/pcf.html');">pcf</a>
auth backend allows Vault login for PCF instances.
It leverages <a href="javascript:window.open('https://content.pivotal.io/blog/new-in-pcf-2-1-app-container-identity-assurance-via-automatic-cert-rotation');">PCF&#8217;s App and Container Identity Assurance</a>.</p>
</div>
<div class="paragraph">
<p>PCF authentication uses the instance key and certificate to create a signature that is validated by Vault.
If the signature matches, and potentially bound organization/space/application Id&#8217;s match, Vault issues an appropriately-scoped token.</p>
</div>
<div class="paragraph">
<p>Instance credentials are available from files at <code>CF_INSTANCE_CERT</code> and
<code>CF_INSTANCE_KEY</code> variables.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        PcfAuthenticationOptions options = PcfAuthenticationOptions.builder()
                .role(…).build();

        PcfAuthentication authentication = new PcfAuthentication(options,
                restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>PcfAuthenticationOptions</code> requires the <a href="javascript:window.open('https://www.bouncycastle.org/latest_releases.html');">BouncyCastle</a>
library for creating RSA-PSS signatures.</p>
</div>
<div class="paragraph">
<p>You can configure the authentication via <code>PcfAuthenticationOptions</code>.</p>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/pcf.html');">Vault Documentation:
Using the PCF auth backend</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.clientcert"><a class="anchor" href="#vault.authentication.clientcert"></a>14.11. TLS certificate authentication</h3>
<div class="paragraph">
<p>The <code>cert</code> auth backend allows authentication using SSL/TLS client
certificates that are either signed by a CA or self-signed.</p>
</div>
<div class="paragraph">
<p>To enable <code>cert</code> authentication you need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use SSL, see <a href="#vault.client-ssl">Vault Client SSL configuration</a></p>
</li>
<li>
<p>Configure a Java <code>Keystore</code> that contains the client
certificate and the private key</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {
        return new ClientCertificateAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See also: <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/cert.html');">Vault Documentation: Using the Cert auth backend</a></p>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.cubbyhole"><a class="anchor" href="#vault.authentication.cubbyhole"></a>14.12. Cubbyhole authentication</h3>
<div class="paragraph">
<p>Cubbyhole authentication uses Vault primitives to provide a secured authentication
workflow. Cubbyhole authentication uses tokens as primary login method.
An ephemeral token is used to obtain a second, login VaultToken from Vault&#8217;s
Cubbyhole secret backend. The login token is usually longer-lived and used to
interact with Vault. The login token can be retrieved either from a wrapped
response or from the <code>data</code> section.</p>
</div>
<div class="paragraph">
<p><strong>Creating a wrapped token</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Response Wrapping for token creation requires Vault 0.6.0 or higher.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 28. Crating and storing tokens</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ vault token-create -wrap-ttl="10m"
Key                            Value
---                            -----
wrapping_token:                397ccb93-ff6c-b17b-9389-380b01ca2645
wrapping_token_ttl:            0h10m0s
wrapping_token_creation_time:  2016-09-18 20:29:48.652957077 +0200 CEST
wrapped_accessor:              46b6aebb-187f-932a-26d7-4f3d86a68319</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 29. Wrapped token response usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        CubbyholeAuthenticationOptions options = CubbyholeAuthenticationOptions
                .builder()
                .initialToken(VaultToken.of("…"))
                .wrapped()
                .build();

        return new CubbyholeAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Using stored tokens</strong></p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Crating and storing tokens</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ vault token create
Key                    Value
---                    -----
token                  f9e30681-d46a-cdaf-aaa0-2ae0a9ad0819
token_accessor         4eee9bd9-81bb-06d6-af01-723c54a72148
token_duration         0s
token_renewable        false
token_policies         [root]

$ vault token create -use-limit=2 -orphan -no-default-policy -policy=none
Key                    Value
---                    -----
token                  895cb88b-aef4-0e33-ba65-d50007290780
token_accessor         e84b661c-8aa8-2286-b788-f258f30c8325
token_duration         0s
token_renewable        false
token_policies         [none]

$ export VAULT_TOKEN=895cb88b-aef4-0e33-ba65-d50007290780
$ vault write cubbyhole/token token=f9e30681-d46a-cdaf-aaa0-2ae0a9ad0819</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 31. Stored token response usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        CubbyholeAuthenticationOptions options = CubbyholeAuthenticationOptions
                .builder()
                .initialToken(VaultToken.of("…"))
                .path("cubbyhole/token")
                .build();

        return new CubbyholeAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>Remaining TTL/Renewability</strong></p>
</div>
<div class="paragraph">
<p>Tokens retrieved from Cubbyhole associated with a non-zero TTL start their TTL at the
time of token creation. That time is not necessarily identical with application
startup. To compensate for the initial delay, Cubbyhole authentication performs a
self lookup for tokens associated with a non-zero TTL to retrieve the remaining TTL.
Cubbyhole authentication will not self-lookup wrapped tokens without a TTL because a
zero TTL indicates there is no TTL associated.</p>
</div>
<div class="paragraph">
<p>Non-wrapped tokens do not provide details regarding renewability and TTL by just
retrieving the token. A self-lookup will lookup renewability and the remaining TTL.</p>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/concepts/tokens.html');">Vault Documentation: Tokens</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/secrets/cubbyhole/index.html');">Vault Documentation: Cubbyhole Secret Backend</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/concepts/response-wrapping.html');">Vault Documentation: Response Wrapping</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.kubernetes"><a class="anchor" href="#vault.authentication.kubernetes"></a>14.13. Kubernetes authentication</h3>
<div class="paragraph">
<p>Vault supports since 0.8.3 <a href="javascript:window.open('https://www.vaultproject.io/docs/auth/kubernetes.html');">kubernetes</a>-based authentication using Kubernetes tokens.</p>
</div>
<div class="paragraph">
<p>Using Kubernetes authentication requires a Kubernetes Service Account Token,
usually mounted at <code>/var/run/secrets/kubernetes.io/serviceaccount/token</code>.
The file contains the token which is read and sent to Vault.
Vault verifies its validity using Kubernetes' API during login.</p>
</div>
<div class="paragraph">
<p>Configuring Kubernetes authentication requires at least the role name to be provided:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
class AppConfig extends AbstractVaultConfiguration {

    // …

    @Override
    public ClientAuthentication clientAuthentication() {

        KubernetesAuthenticationOptions options = KubernetesAuthenticationOptions.builder()
                .role(…).jwtSupplier(…).build();

        return new KubernetesAuthentication(options, restOperations());
    }

    // …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can configure the authentication via <code>KubernetesAuthenticationOptions</code>.</p>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://www.vaultproject.io/docs/auth/kubernetes.html');">Vault Documentation: Using the Kubernetes auth backend</a></p>
</li>
<li>
<p><a href="javascript:window.open('https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/');">Kubernetes Documentation: Configure Service Accounts for Pods</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.steps"><a class="anchor" href="#vault.authentication.steps"></a>14.14. Authentication Steps</h3>
<div class="paragraph">
<p><code>ClientAuthentication</code> objects describe the authentication flow and perform the actual
authentication steps. Pre-composed authentications are easy to use and to configure with
a tight binding to synchronous execution.</p>
</div>
<div class="paragraph">
<p>The composition of authentication methods and reusing common steps, such as posting login
payload to Vault or retrieving authentication input from an HTTP source is not intended
with <code>ClientAuthentication</code> objects.</p>
</div>
<div class="paragraph">
<p>Authentication steps provide reusability of common authentication activity.
Steps created via <code>AuthenticationSteps</code> describe an authentication flow in a functional
style leaving the actual authentication execution to specific executors.</p>
</div>
<div class="exampleblock">
<div class="title">Example 32. Stored token authentication flow.</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">AuthenticationSteps.just(VaultToken.of(…));                              <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates <code>AuthenticationSteps</code> from just a <code>VaultToken</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>A single-step authentication flow can be created from a single input. Flows declaring
multiple authentication steps start with a <code>Supplier</code> or <code>HttpRequest</code> that provide an
authentication state object which can be used to map or post to Vault for login.</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. AppRole authentication flow</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">AuthenticationSteps.fromSupplier(                                       <i class="conum" data-value="1"></i><b>(1)</b>

    () -&gt; getAppRoleLogin(options.getRoleId(), options.getSecretId()))  <i class="conum" data-value="2"></i><b>(2)</b>

    .login("auth/{mount}/login", options.getPath());                    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start declaring <code>AuthenticationSteps</code> accepting a <code>Supplier&lt;T&gt;</code>.
The state object type depends on the <code>Supplier</code> response type which can be mapped in a later step.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The actual <code>Supplier</code> implementation.
Creating a <code>Map</code> in this case.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Perform a Vault login by posting the state object (<code>Map</code>) to a Vault endpoint for Vault token creation.
Note that template variables are subject to URL escaping.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Authentication flows require an executor to perform the actual login. We provide two executors
for different execution models:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AuthenticationStepsExecutor</code> as a drop-in replacement for synchronous <code>ClientAuthentication</code>.</p>
</li>
<li>
<p><code>AuthenticationStepsOperator</code> for reactive execution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many <code>ClientAuthentication</code>'s come with static factory methods to create <code>AuthenticationSteps</code>
for their authentication-specific options:</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Synchronous <code>AuthenticationSteps</code> execution</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CubbyholeAuthenticationOptions options = …
RestOperations restOperations = …

AuthenticationSteps steps = CubbyholeAuthentication.createAuthenticationSteps(options);

AuthenticationStepsExecutor executor = new AuthenticationStepsExecutor(steps, restOperations);

VaultToken token = executor.login();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vault.authentication.session"><a class="anchor" href="#vault.authentication.session"></a>14.15. Token Lifecycle</h3>
<div class="paragraph">
<p>Vault&#8217;s tokens can be associated with a time to live. Tokens obtained by an authentication method
are intended to be used as long as the session is active and should not expire while the application is active.</p>
</div>
<div class="paragraph">
<p>Spring Vault provides with <a href="javascript:window.open('https://docs.spring.io/spring-vault/docs/2.2.2.RELEASE/api/org/springframework/vault/authentication/LifecycleAwareSessionManager.html');"><code>LifecycleAwareSessionManager</code></a> a session manager that can renew the token until it reaches its terminal TTL to then perform another login to obtain the next token which is associated with the session.</p>
</div>
<div class="paragraph">
<p>Depending on the authentication method, a login can create two kinds of tokens:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="javascript:window.open('https://docs.spring.io/spring-vault/docs/2.2.2.RELEASE/api/org/springframework/vault/support/VaultToken.html');"><code>VaultToken</code></a>: Generic token encapsulating the actual token.</p>
</li>
<li>
<p><a href="javascript:window.open('https://docs.spring.io/spring-vault/docs/2.2.2.RELEASE/api/org/springframework/vault/support/LoginToken.html');"><code>LoginToken</code></a>: Token associated with renewability/TTL.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authentication methods such as <a href="javascript:window.open('https://docs.spring.io/spring-vault/docs/2.2.2.RELEASE/api/org/springframework/vault/authentication/TokenAuthentication.html');"><code>TokenAuthentication</code></a> just create a <code>VaultToken</code> which does not carry any renewability/TTL details. <code>LifecycleAwareSessionManager</code> will run a self-lookup on the token to retrieve renewability and TTL from Vault.
<code>VaultToken</code> are renewed periodically if self-lookup is enabled. Note that <code>VaultToken</code> are never revoked, only <code>LoginToken</code> are revoked.</p>
</div>
<div class="paragraph">
<p>Authentication methods creating <code>LoginToken</code> directly (all login-based authentication methods) already provide all necessary details to setup token renewal. Tokens obtained from a login are revoked by <code>LifecycleAwareSessionManager</code> if the session manager is shut down.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vault.misc"><a class="anchor" href="#vault.misc"></a>15. Miscellaneous</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learn in this chapter about details worth mentioning like the Spring Security integration.</p>
</div>
<div class="sect2">
<h3 id="vault.misc.spring-security"><a class="anchor" href="#vault.misc.spring-security"></a>15.1. Spring Security</h3>
<div class="paragraph">
<p>Spring Vault integrates with Spring Security by providing implementations for <a href="index20.html#spring-security-crypto-keygenerators"><code>BytesKeyGenerator</code></a> and <a href="index20.html#spring-security-crypto-encryption"><code>BytesEncryptor</code></a>. Both implementations use Vault&#8217;s <code>transit</code> backend.</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. <code>VaultBytesKeyGenerator</code> example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">VaultOperations operations = …;
VaultBytesKeyGenerator generator = new VaultBytesKeyGenerator(operations);

byte[] key = generator.generateKey();</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 36. <code>VaultBytesEncryptor</code> example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">VaultTransitOperations transit = …;

VaultBytesEncryptor encryptor = new VaultBytesEncryptor(transit, "my-key-name");

byte[] ciphertext = encryptor.encrypt(plaintext);

byte[] result = encryptor.decrypt(ciphertext);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Vault encapsulates an entropy source that is decoupled from your JVM along with server-side key-management. This relieves the burden of proper encryption/decryption from application developers and pushes the burden onto the operators of Vault. Operators of Vault commonly include the security team at an organization, which means they can ensure that data is encrypted/decrypted properly. Additionally, since encrypt/decrypt operations must enter the audit log, any decryption event is recorded.</p>
</div>
<div class="paragraph">
<p>The backend also supports key rotation, which allows a new version of the named key to be generated. All data encrypted with the key will use the newest version of the key; previously encrypted data can be decrypted using old versions of the key. Administrators can control which previous versions of a key are available for decryption, to prevent an attacker gaining an old copy of ciphertext to be able to successfully decrypt it.</p>
</div>
<div class="paragraph">
<p>Vault is after all a networked service that incurs each operation with a latency. Components heavily using encryption or random bytes generation may experience a difference in throughput and performance.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.2.2.RELEASE<br>
Last updated 2020-02-26 13:52:31 MEZ
</div>
</div>
<script type="text/javascript" src="static/js/tocbot.min.js"></script>
<script type="text/javascript" src="static/js/toc2.js"></script>
<link rel="stylesheet" href="static/css/atom-one-dark-reasonable.min.css">
<script src="static/js/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script>if(window.parent==window){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-2728886-23','auto',{'siteSpeedSampleRate':100});ga('send','pageview');}</script></body>
</html>